--select процедура за търсене на книги по автор
CREATE OR REPLACE PROCEDURE search_books_by_author (v_AUTHOR VARCHAR2)
IS
CURSOR CUR_BOOKS
IS
SELECT b.BOOK_ID, b.TITLE, a.NAME AS AUTHOR
FROM BOOK b
JOIN BOOK_AUTHOR ba ON b.BOOK_ID = ba.BOOK_ID
JOIN AUTHOR a ON ba.AUTHOR_ID = a.AUTHOR_ID 
WHERE LOWER(a.NAME) LIKE '%' || LOWER(v_AUTHOR)||'%';

C_ID BOOK.BOOK_ID%TYPE;
C_TITLE BOOK.TITLE%TYPE;
C_AUTHOR AUTHOR.NAME%TYPE;

BEGIN
OPEN CUR_BOOKS;
LOOP
FETCH CUR_BOOKS INTO C_ID, C_TITLE, C_AUTHOR;
EXIT WHEN CUR_BOOKS%NOTFOUND;
DBMS_OUTPUT.PUT_LINE('ID: '||C_ID||' | Book: '|| C_TITLE || '| Author: '|| C_AUTHOR);
END LOOP;
CLOSE CUR_BOOKS;
END search_books_by_author;
/


BEGIN
    search_books_by_author('Green');
END;
/

--select процедура за търсене на книги по жанр
CREATE OR REPLACE PROCEDURE search_books_by_genre (v_genre VARCHAR2)
IS
CURSOR CUR_GENRE
IS
SELECT b.BOOK_ID, b.TITLE, g.NAME AS GENRE, p.NAME AS PUBLISHER
FROM BOOK b
JOIN GENRE g ON b.GENRE_ID = g.GENRE_ID
JOIN PUBLISHER p ON b.PUBLISHER_ID = p.PUBLISHER_ID
WHERE LOWER(g.NAME) LIKE '%' || LOWER(v_genre) || '%';

C_ID BOOK.BOOK_ID%TYPE;
C_TITLE BOOK.TITLE%TYPE;
C_GENRE GENRE.NAME%TYPE;
C_PUBLISHER PUBLISHER.NAME%TYPE;

BEGIN
OPEN CUR_GENRE;
LOOP
FETCH CUR_GENRE INTO C_ID, C_TITLE, C_GENRE, C_PUBLISHER;
EXIT WHEN CUR_GENRE%NOTFOUND;
DBMS_OUTPUT.PUT_LINE('ID: '||C_ID|| '| Title: '||C_TITLE||' | Genre: '|| C_GENRE || '| Publisher: '|| C_PUBLISHER);
END LOOP;
CLOSE CUR_GENRE;
END search_books_by_genre;
/

--select процедура за търсене на книги по издателство
CREATE OR REPLACE PROCEDURE search_books_by_publisher (v_publisher VARCHAR2) 
IS
CURSOR CUR_PUBLISHER 
IS 
SELECT b.BOOK_ID, b.TITLE, p.NAME AS PUBLISHER
FROM BOOK b
JOIN PUBLISHER p ON b.PUBLISHER_ID = p.PUBLISHER_ID
WHERE LOWER(p.NAME) LIKE '%' || LOWER(v_publisher) || '%';
        
C_ID BOOK.BOOK_ID%TYPE;
C_TITLE BOOK.TITLE%TYPE;
C_PUBLISHER PUBLISHER.NAME%TYPE;
    
BEGIN
OPEN CUR_PUBLISHER;
LOOP
FETCH CUR_PUBLISHER INTO C_ID, C_TITLE, C_PUBLISHER;
EXIT WHEN CUR_PUBLISHER%NOTFOUND;
DBMS_OUTPUT.PUT_LINE('ID: '||C_ID|| '| Title: '||C_TITLE|| '| Publisher: '|| C_PUBLISHER);
END LOOP;
CLOSE CUR_PUBLISHER;
END search_books_by_publisher;
/

--select процедура за приходи от продажби на служител за период
CREATE OR REPLACE PROCEDURE REPORT_EMPLOYEE_REVENUE (v_START_DATE DATE, v_END_DATE DATE) 
IS
CURSOR CUR_EMPLOYEE
IS 
SELECT e.EMPLOYEE_ID, e.NAME as EMPLOYEE, SUM(o.PRICE) AS TOTAL_REVENUE
FROM ORDERS o
JOIN EMPLOYEE e ON o.EMPLOYEE_ID = e.EMPLOYEE_ID
WHERE o.ORDER_DATE BETWEEN v_START_DATE AND v_END_DATE
GROUP BY e.EMPLOYEE_ID, e.NAME
ORDER BY TOTAL_REVENUE DESC;
        
C_ID EMPLOYEE.EMPLOYEE_ID%TYPE;
C_NAME  EMPLOYEE.NAME%TYPE;
C_TOTAL NUMBER(10,2);
    
BEGIN
OPEN CUR_EMPLOYEE;
LOOP
FETCH CUR_EMPLOYEE INTO C_ID, C_NAME, C_TOTAL;
EXIT WHEN CUR_EMPLOYEE%NOTFOUND;
DBMS_OUTPUT.PUT_LINE('ID: '||C_ID|| '| Employee: '||C_NAME|| '| Revenue: '|| C_TOTAL);
END LOOP;
CLOSE CUR_EMPLOYEE;
END REPORT_EMPLOYEE_REVENUE;
/

--select процедура за брой продадени книги подредени по количество 
CREATE OR REPLACE PROCEDURE REPORT_BOOK_SALES
IS
CURSOR CUR_SALES
IS 
SELECT b.BOOK_ID, b.TITLE, a.NAME AS AUTHOR,p.NAME AS PUBLISHER, SUM(ob.QUANTITY) AS TOTAL_SOLD
FROM ORDERED_BOOKS ob
JOIN BOOK b ON ob.BOOK_ID = b.BOOK_ID
JOIN PUBLISHER p ON b.PUBLISHER_ID = p.PUBLISHER_ID
JOIN BOOK_AUTHOR ba ON b.BOOK_ID = ba.BOOK_ID
JOIN AUTHOR a ON ba.AUTHOR_ID = a.AUTHOR_ID
GROUP BY b.BOOK_ID, b.TITLE, a.NAME, p.NAME
ORDER BY TOTAL_SOLD DESC;
        
C_ID BOOK.BOOK_ID%TYPE;
C_TITLE BOOK.TITLE%TYPE;
C_AUTHOR AUTHOR.NAME%TYPE;
C_PUBLISHER PUBLISHER.NAME%TYPE;
C_TOTAL NUMBER;
    
BEGIN
DBMS_OUTPUT.PUT_LINE('--- ALL BOOK SALES STATS ---');
OPEN CUR_SALES;
LOOP
FETCH CUR_SALES INTO C_ID, C_TITLE, C_AUTHOR, C_PUBLISHER, C_TOTAL;
EXIT WHEN CUR_SALES%NOTFOUND;
DBMS_OUTPUT.PUT_LINE('ID: '||C_ID|| '| Title: '||C_TITLE|| '| Author: '|| C_AUTHOR|| '| Publisher: '|| C_PUBLISHER|| '| Total sold: '|| C_TOTAL);
END LOOP;
CLOSE CUR_SALES;
END REPORT_BOOK_SALES;
/

--select процедура за топ 3 автори с най-много продадени книги
CREATE OR REPLACE PROCEDURE REPORT_TOP_AUTHORS(v_LIMIT NUMBER)
IS
CURSOR CUR_TOP_AUTHOR
IS 
SELECT *
FROM (
  SELECT a.AUTHOR_ID, a.NAME AS AUTHOR, SUM(ob.QUANTITY) AS TOTAL_SOLD
  FROM ORDERED_BOOKS ob 
  JOIN BOOK b ON ob.BOOK_ID = b.BOOK_ID
  JOIN BOOK_AUTHOR ba ON b.BOOK_ID=ba.BOOK_ID
  JOIN AUTHOR a ON ba.AUTHOR_ID=a.AUTHOR_ID
  GROUP BY a.AUTHOR_ID, a.NAME
  ORDER BY TOTAL_SOLD DESC
)
WHERE ROWNUM <= v_LIMIT;
        
C_ID AUTHOR.AUTHOR_ID%TYPE;
C_AUTHOR AUTHOR.NAME%TYPE;
C_TOTAL NUMBER;
    
BEGIN
DBMS_OUTPUT.PUT_LINE('--- TOP ' || v_limit || ' AUTHORS ---');
OPEN CUR_TOP_AUTHOR;
LOOP
FETCH CUR_TOP_AUTHOR INTO C_ID, C_AUTHOR, C_TOTAL;
EXIT WHEN CUR_TOP_AUTHOR%NOTFOUND;
DBMS_OUTPUT.PUT_LINE('ID: '||C_ID|| '| Author: '|| C_AUTHOR|| '| Total sold: '|| C_TOTAL);
END LOOP;
CLOSE CUR_TOP_AUTHOR;
END REPORT_TOP_AUTHORS;
/

--select процедура за последните 5 поръчки, подредени по дата
CREATE OR REPLACE PROCEDURE REPORT_LATEST_ORDERS(v_LIMIT NUMBER)
IS
CURSOR CUR_LATEST_ORDER
IS 
SELECT *
FROM (
  SELECT o.ORDER_ID, c.CUSTOMER_ID, c.NAME AS CUSTOMER, o.ORDER_DATE, o.PRICE 
  FROM ORDERS o
  JOIN CUSTOMER c ON o.CUSTOMER_ID=c.CUSTOMER_ID
  ORDER BY o.ORDER_DATE DESC
)
WHERE ROWNUM <= v_LIMIT;
        
C_ORDER_ID ORDERS.ORDER_ID%TYPE;
C_CUSTOMER_ID CUSTOMER.CUSTOMER_ID%TYPE;
C_CUSTOMER CUSTOMER.NAME%TYPE;
C_DATE ORDERS.ORDER_DATE%TYPE;
C_PRICE ORDERS.PRICE%TYPE;
    
BEGIN
DBMS_OUTPUT.PUT_LINE('--- LATEST ' || v_limit || ' ORDERS ---');
OPEN CUR_LATEST_ORDER;
LOOP
FETCH CUR_LATEST_ORDER INTO C_ORDER_ID, C_CUSTOMER_ID, C_CUSTOMER, C_DATE, C_PRICE ;
EXIT WHEN CUR_LATEST_ORDER%NOTFOUND;
DBMS_OUTPUT.PUT_LINE('Order ID: '||C_ORDER_ID|| '| Customer ID: '|| C_CUSTOMER_ID|| '| Customer: '|| C_CUSTOMER ||'| Order date: '|| C_DATE ||'| Price: '|| C_PRICE);
END LOOP;
CLOSE CUR_LATEST_ORDER;
END REPORT_LATEST_ORDERS;
/

--процедура за добавяне на нова книга insert
CREATE OR REPLACE PROCEDURE INSERT_BOOK(
v_BOOK_ID BOOK.BOOK_ID%TYPE,
v_TITLE BOOK.TITLE%TYPE,
v_YEAR BOOK.PUBLISHING_YEAR%TYPE,
v_GENRE_ID BOOK.GENRE_ID%TYPE,
v_PUBLISHER_ID BOOK.PUBLISHER_ID%TYPE,
v_PRICE BOOK.PRICE%TYPE
)
IS
BEGIN
INSERT INTO BOOK(BOOK_ID, TITLE, PUBLISHING_YEAR, GENRE_ID, PUBLISHER_ID, PRICE)
VALUES(v_BOOK_ID, v_TITLE, v_YEAR, v_GENRE_ID, v_PUBLISHER_ID, v_PRICE);
DBMS_OUTPUT.PUT_LINE('Success: Book "' || v_TITLE || '" added.');
END INSERT_BOOK;
/

SELECT *FROM BOOK;
BEGIN
INSERT_BOOK(20, 'Ivy',2020,1,1,13.13);
END;
/

--процедура за редактиране на книга update 
CREATE OR REPLACE PROCEDURE UPDATE_BOOK_PRICE 
(
v_BOOK_ID BOOK.BOOK_ID%TYPE, 
v_PRICE BOOK.PRICE%TYPE
) 
IS 
BEGIN 
UPDATE BOOK 
SET PRICE = v_PRICE 
WHERE BOOK_ID = v_BOOK_ID; 
END UPDATE_BOOK_PRICE; 
/

--процедура за изтриване на книга
CREATE OR REPLACE PROCEDURE DELETE_BOOK(
v_BOOK_ID BOOK.BOOK_ID%TYPE
)
IS
BEGIN
DELETE FROM BOOK
WHERE BOOK_ID = v_BOOK_ID;
END DELETE_BOOK; 
/

BEGIN 
DELETE_BOOK(20);
END;
/

--процедура за добавяне на нов клиент insert
CREATE OR REPLACE PROCEDURE INSERT_CUSTOMER(
v_CUSTOMER_ID CUSTOMER.CUSTOMER_ID%TYPE,
v_NAME CUSTOMER.NAME%TYPE,
v_ADDRESS CUSTOMER.ADDRESS%TYPE,
v_EMAIL CUSTOMER.EMAIL%TYPE,
v_PHONE CUSTOMER.PHONE_NUMBER%TYPE
)
IS
BEGIN
INSERT INTO CUSTOMER(CUSTOMER_ID, NAME, ADDRESS, EMAIL, PHONE_NUMBER)
VALUES(v_CUSTOMER_ID, v_NAME, v_ADDRESS, v_EMAIL, v_PHONE);
DBMS_OUTPUT.PUT_LINE('Success: Customer "' || v_NAME || '" added.');
END INSERT_CUSTOMER;
/

--процедура за добавяне на нов служител insert
CREATE OR REPLACE PROCEDURE INSERT_EMPLOYEE(
v_EMPLOYEE_ID EMPLOYEE.EMPLOYEE_ID%TYPE,
v_NAME EMPLOYEE.NAME%TYPE,
v_POSITION_ID EMPLOYEE.POSITION_ID%TYPE,
v_PHONE EMPLOYEE.PHONE_NUMBER%TYPE
)
IS
BEGIN
INSERT INTO EMPLOYEE(EMPLOYEE_ID, NAME, POSITION_ID, PHONE_NUMBER)
VALUES(v_EMPLOYEE_ID, v_NAME, v_POSITION_ID, v_PHONE);
DBMS_OUTPUT.PUT_LINE('Success: Employee "' || v_NAME || '" added.');
END INSERT_EMPLOYEE;
/

--процедура за редакция на служител update
CREATE OR REPLACE PROCEDURE UPDATE_EMPLOYEE(
v_EMPLOYEE_ID EMPLOYEE.EMPLOYEE_ID%TYPE,
v_NEW_NAME EMPLOYEE.NAME%TYPE,
v_NEW_POSITION_ID EMPLOYEE.POSITION_ID%TYPE,
v_NEW_PHONE EMPLOYEE.PHONE_NUMBER%TYPE
)
IS
BEGIN
UPDATE EMPLOYEE
SET NAME = v_NEW_NAME,
POSITION_ID = v_NEW_POSITION_ID,
PHONE_NUMBER = v_NEW_PHONE
WHERE EMPLOYEE_ID = v_EMPLOYEE_ID;
END UPDATE_EMPLOYEE;
/

--процедура за изтриване на служител
CREATE OR REPLACE PROCEDURE DELETE_EMPLOYEE(
v_EMPLOYEE_ID EMPLOYEE.EMPLOYEE_ID%TYPE
)
IS
BEGIN
DELETE FROM EMPLOYEE
WHERE EMPLOYEE_ID = v_EMPLOYEE_ID;
END DELETE_EMPLOYEE;
/

--процедура за добавяне на работна позиция
CREATE OR REPLACE PROCEDURE INSERT_POSITION(
v_POSITION_ID WORK_POSITIONS.POSITION_ID%TYPE,
v_NAME WORK_POSITIONS.NAME%TYPE
)
IS
BEGIN
INSERT INTO WORK_POSITIONS(POSITION_ID, NAME)
VALUES(v_POSITION_ID, v_NAME);
DBMS_OUTPUT.PUT_LINE('Success: Position "' || v_NAME || '" added.');
END INSERT_POSITION;
/

--процедура за редакция на работна позиция update
CREATE OR REPLACE PROCEDURE UPDATE_POSITION(
v_POSITION_ID WORK_POSITIONS.POSITION_ID%TYPE,
v_NEW_NAME WORK_POSITIONS.NAME%TYPE
)
IS
BEGIN
UPDATE WORK_POSITIONS
SET NAME = v_NEW_NAME
WHERE POSITION_ID = v_POSITION_ID;
END UPDATE_POSITION;
/


--процедура за изтриване на позиция delete
CREATE OR REPLACE PROCEDURE DELETE_POSITION(
v_POSITION_ID WORK_POSITIONS.POSITION_ID%TYPE
)
IS
BEGIN
DELETE FROM WORK_POSITIONS
WHERE POSITION_ID = v_POSITION_ID;
END DELETE_POSITION;
/

--процедура за редактиране на клиент update
CREATE OR REPLACE PROCEDURE UPDATE_CUSTOMER(
v_CUSTOMER_ID CUSTOMER.CUSTOMER_ID%TYPE,
v_NEW_ADDRESS CUSTOMER.ADDRESS%TYPE,
v_NEW_PHONE CUSTOMER.PHONE_NUMBER%TYPE
)
IS
BEGIN
UPDATE CUSTOMER
SET ADDRESS = v_NEW_ADDRESS, PHONE_NUMBER= v_NEW_PHONE
WHERE CUSTOMER_ID = v_CUSTOMER_ID;
END UPDATE_CUSTOMER;
/

--процедура за изртиване на клиент delete
CREATE OR REPLACE PROCEDURE DELETE_CUSTOMER(
v_CUSTOMER_ID CUSTOMER.CUSTOMER_ID%TYPE
)
IS
BEGIN
DELETE FROM CUSTOMER
WHERE CUSTOMER_ID = v_CUSTOMER_ID;
END DELETE_CUSTOMER; 
/

